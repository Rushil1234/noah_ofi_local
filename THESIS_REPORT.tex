\documentclass[11pt, a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\geometry{margin=1in}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{float}
\usepackage{amsmath}
\usepackage{caption}
\usepackage{setspace}
\onehalfspacing

% Colors for code listings
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\title{\textbf{Order Flow Imbalance (OFI) Prediction Analysis} \\ \large Comprehensive Technical Report}
\author{Rushil Kakkad}
\date{January 6, 2026}

\begin{document}

\maketitle
\begin{abstract}
This study investigates the predictive structure of Order Flow Imbalance (OFI) for high-frequency trading applications. Using millisecond-level NBBO data for Apple Inc. (AAPL) and Microsoft Corp. (MSFT) throughout 2023, we construct a comprehensive dataset of 5-minute OFI bars. We demonstrate that OFI exhibits strong short-memory persistence (lag-1 autocorrelation $\approx 0.56$) but limited long-range dependence. Predictive modeling using XGBoost achieves a directional accuracy of 79\%, significantly outperforming deep learning approaches (LSTM), suggesting that the underlying process is governed by simple autoregressive dynamics rather than complex latent sequences. Furthermore, we document significant cross-asset Granger causality, where MSFT order flow provides incremental predictive information for AAPL, highlighting a mechanism for correlated price formation. Importantly, we distinguish between informational predictability (sign accuracy) and economic alpha, noting that transaction costs and execution latency likely constrain the direct tradability of these signals.
\end{abstract}

\tableofcontents
\newpage

\section{Introduction}

Understanding the dynamics of order flow imbalance (OFI) is central to market microstructure, as order flow represents the primary mechanism through which information and liquidity demands are transmitted into prices. While prior literature has documented strong contemporaneous relationships between order flow and returns, the extent to which order flow exhibits predictable structure across time and across assets remains an open question.

In modern electronic markets, the limit order book (LOB) serves as the nexus of supply and demand. OFI, defined as the net buy vs. sell pressure at the best bid and ask quotes, is widely considered the most immediate driver of valid price changes. However, the academic consensus has often treated order flow as a martingale difference sequenceâ€”unpredictable in the efficient market limit. This thesis challenges that assumption by explicitly testing for temporal structure and forecasting power in aggregated OFI series.

The economic significance of OFI predictability extends beyond simple arbitrage. If order flow is predictable, it implies that liquidity provision is not instantaneous and that supply-demand imbalances persist over human-perceptible timescales (minutes). This persistence can induce "toxicity" for market makers, who may be adversely selected by informed traders splitting large parent orders. Conversely, for institutional execution algorithms, predicting future OFI allows for optimal scheduling of trades to minimize impact.

We focus specifically on the 5-minute aggregation horizon. This choice is deliberate: it bridges the gap between high-frequency microstructure noise (tick level) and low-frequency asset pricing factors (daily level). At this frequency, valid signals must survive the rapid cancellation behavior of HFT algorithms, representing robust, persistent institutional demand.

Furthermore, this study introduces a cross-asset dimension by analyzing the interplay between AAPL and MSFT. These assets are heavily linked through index funds (S\&P 500, Nasdaq 100) and ETFs (XLK, QQQ). We hypothesize that liquidity shocks to one asset diffuse to the other, not instantaneously, but with measurable lag. Validating this hypothesis provides specific evidence for the "common factor" theory of liquidity, where ETF flows force correlated order imbalances across constituents.

\section{Literature Review}

\subsection{Order Flow and Price Formation}
The theoretical foundation of this work rests on the seminal contributions of Kyle (1985) and Glosten and Milgrom (1985), who established that informed trading reveals itself through order flow. Cont, Kukanov, and Stoikov (2014) formalized the definition of Order Flow Imbalance (OFI) essentially as the net flow of limit orders at the best quotes. They demonstrated a near-linear relationship between contemporaneous OFI and price impact, a finding robust across asset classes.

Hasbrouck (1991) utilized vector autoregression (VAR) to decompose price changes into trade-related and information-related components, arguing that "trades drive quotes." Our work extends this by asking whether the trades (or specifically, the LOB imbalances) drive \textit{future} imbalances, a second-order effect implying persistence in liquidity demand. We view OFI not just as a static variable, but as a stochastic process with memory.

\subsection{Short-Horizon Predictability}
Empirical studies on high-frequency predictability often encounter the efficient market hypothesis in its strongest form. While returns are notoriously difficult to forecast ($R^2 \approx 0$), order flow is widely acknowledged to possess "long memory" (Bouchaud et al., 2004). This persistence is attributed to order splitting: large institutional parents are sliced into child orders executed over time, creating a localized correlation in sign.

Despite this, machine learning applications often fail to produce trading alpha. We argue this is due to a mismatch in complexity. As demonstrated by Sirignano and Cont (2019) with the "Universal Price Formation" model, deep learning shines on raw LOB states. However, for aggregated metrics like our 5-minute OFI, the signal-to-noise ratio favors parsimonious models. Our findings confirm that simple gradient boosting (XGBoost) outperforms complex sequence models (LSTM) when features are carefully engineered, consistent with the "no free lunch" theorem in financial ML.

\subsection{Cross-Asset Microstructure}
The literature on cross-asset effects is dominated by lead-lag relationships in returns. We pivot this to lead-lag relationships in \textit{liquidity}. Beta arbitrage and index arbitrage create mechanical links between assets. When an ETF is bought, Market Makers hedge by buying the constituents. Since execution is not simultaneous, order flow in highly liquid leaders (like MSFT) often precedes flow in peers.

This "common factor" view of order flow suggests that idiosyncratic OFI is mean-reverting (noise), while systematic OFI (shared across assets) drives trends. Our Granger causality results provide empirical support for this transmission mechanism.

\section{Data}

\subsection{Data Source and Selection}
We utilize the **WRDS TAQ Millisecond (TAQM)** database, specifically the NBBO (National Best Bid and Offer) files. This dataset is the gold standard for US equity microstructure research, providing timestamps with nanosecond precision for every quote update across all exchanges.

We select Apple Inc. (AAPL) and Microsoft Corp. (MSFT) for the full year 2023. These are two of the most liquid instruments globally, ensuring that our results are not artifacts of illiquidity or discrete pricing discreteness.

\subsection{Methodology: 5-Minute Aggregation}
While millisecond data is available, we aggregate order flow to five-minute intervals. This decision balances valid signal extraction against microstructure noise. Tick-by-tick data is dominated by "flickering quotes"â€”rapid updates and cancellations by HFTs that carry no informational content for directional prediction. By summing signed volume contributions over 5 minutes, we filter out high-frequency noise and capture the "latent demand" of slower, informed institutional traders.

\subsection{Limitations of NBBO Data}
We rely on Level 1 (Top of Book) data. While Level 2 (Full Depth) data would provide queue imbalance information, experimental evidence suggests that the majority of price discovery occurs at the touch (best bid/ask). Using NBBO allows for a computationally tractable dataset while capturing the most economically significant updates.

\section{Methodology}

\subsection{OFI Metric Construction}
We construct OFI following the "event" definition. For every update $t$:
\[ e_t = I(P^{bid}_t > P^{bid}_{t-1}) q^{bid}_t - I(P^{bid}_t < P^{bid}_{t-1}) q^{bid}_{t-1} + I(P^{bid}_t = P^{bid}_{t-1})(q^{bid}_t - q^{bid}_{t-1}) - \dots \]
(and similarly for the ask side). This precisely captures the net liquidity added or removed from the book.

\subsection{Modeling Strategy}
We compare three distinct modeling approaches to test specific hypotheses about the data generation process:

\begin{enumerate}
    \item \textbf{Autoregressive Baseline (AR)}: Assumes OFI is a linear process dependent only on its own past.
    \item \textbf{XGBoost (Gradient Boosting)}: A non-linear, ensemble tree method. We select this because financial data often exhibits threshold effects (e.g., behavior changes in high vs. low volatility regimes) that linear models miss. XGBoost is robust to outliers and requires minimal preprocessing.
    \item \textbf{LSTM (Long Short-Term Memory)}: A deep recurrent neural network. We include this to test for "hidden states" or complex temporal dependencies. If OFI has long-range memory or complex sequence patterns, LSTM should dominate.
\end{enumerate}

Given the short-memory structure of OFI documented in prior studies, we hypothesize that models with strong inductive biases toward local dependence (like XGBoost) will outperform deep sequence models, which are prone to overfitting in low signal-to-noise regimes.

\subsection{Validation Protocol}
We strictly employ a \textbf{time-series split} (Train: Jan-Sep, Val: Oct-Nov, Test: Dec) rather than random k-fold cross-validation. Financial data is non-stationary and autocorrelated; random splitting yields substantial look-ahead bias (leakage). Our normalization procedure computes Z-score statistics ($\mu, \sigma$) solely on the training set to ensure the test set remains a true out-of-sample evaluation.

\section{Empirical Results}

\subsection{Predictive Performance}

We evaluate performance using MSE and Directional Accuracy. \textbf{Note:} Directional accuracy refers to predicting the \textit{sign of future OFI}, not asset returns. It serves as evidence of order-flow persistence, not necessarily tradable price alpha.

\begin{table}[H]
    \centering
    \begin{tabular}{llll}
        \toprule
        \textbf{Model} & \textbf{MSE} & \textbf{Correlation} & \textbf{Dir. Accuracy} \\
        \midrule
        \textbf{XGBoost} & \textbf{0.499} & \textbf{70.65\%} & \textbf{79.16\%} \\
        LSTM & 0.975 & 15.26\% & 59.05\% \\
        AR(1) Baseline & 0.969 & 16.15\% & 59.11\% \\
        \bottomrule
    \end{tabular}
    \caption{Model Comparison on Test Set (Dec 2023)}
\end{table}

The XGBoost model achieves remarkable performance, explaining nearly 50\% of the variance ($R^2 \approx 0.5$, implied by MSE reduction). The failure of LSTM confirms our hypothesis: the signal is simple and precise, not complex and hidden.

\subsection{Feature Importance and Structure}

\begin{table}[H]
    \centering
    \begin{tabular}{lll}
        \toprule
        \textbf{Feature} & \textbf{Importance} & \textbf{Role} \\
        \midrule
        Current OFI (\texttt{ofi\_z}) & 62.01\% & Primary Signal \\
        Lag-1 OFI & 23.27\% & Momentum \\
        Lags 2-12 & <15\% & Noise Decay \\
        \bottomrule
    \end{tabular}
    \caption{XGBoost Feature Attribution}
\end{table}

This structure is characteristic of an \textbf{AR(1)-like process} with high short-memory persistence. The autocorrelation function (ACF) confirms this, showing a sharp drop from $\sim 0.56$ at Lag-1 to near zero at Lag-6.

\subsection{Cross-Asset Dynamics}
Our Granger causality tests reveal a significant directional relationship:
\begin{itemize}
    \item \textbf{MSFT $\to$ AAPL}: $p = 0.0002$ (Highly Significant)
    \item AAPL $\to$ MSFT: $p = 0.027$ (Marginally Significant)
\end{itemize}

This suggests that MSFT OFI contains incremental predictive information for AAPL. While both assets react to common information, MSFT appears to process this order flow slightly faster, consistent with its role as a primary liquidity vehicle in the technology sector.

\section{Limitations and Future Work}

While our results are statistically robust, we acknowledge key limitations in translating them to economic value.

\subsection{Execution vs. Informational Alpha}
A directional accuracy of 79\% is high, but it predicts order flow, not price. The profit potential depends on the \textit{price impact} coefficient ($\lambda$). If $\lambda$ is low, correctly predicting book imbalance does not yield profit. Furthermore, transaction costs (crossing the spread) would likely erode the edge of a simple OFI-following strategy. This signal is likely best used for \textbf{execution algorithms} (minimizing cost) rather than proprietary trading (seeking variance).

\subsection{Bar Frequency Trade-offs}
Our 5-minute aggregation horizon ignores intra-bar dynamics. A purely HFT approach would require event-by-event modeling (tick level). However, the computational burden and noise levels increase exponentially. Future work could explore a "hierarchical" model: using 5-minute OFI to set a trading bias, and tick-level features for timing.

\subsection{Asset Universality}
Our study is limited to two mega-cap technology stocks. It is unclear if these findings hold for small-cap or illiquid assets, where the order book is sparse and OFI logic may break down. We hypothesize that predictability would be \textit{lower} in illiquid names due to the idiosyncratic nature of trades.

\section{Conclusion}

This thesis provides a rigorous empirical analysis of Order Flow Imbalance. We successfully established a reproducible pipeline from raw WRDS TAQM logs to predictive modeling. Our key contributions are threefold:

First, we documented that aggregate order flow is not a random walk. It exhibits strong, exploitable persistence at the 5-minute horizon. This challenges strong-form efficiency arguments regarding microstructure.

Second, we demonstrated that parsimonious non-linear models (XGBoost) are superior to deep learning (LSTM) for this specific domain. The predictive structure of OFI is dominated by immediate history, rendering complex memory cells redundant.

Third, we uncovered a significant cross-asset transmission mechanism. Correlation in order flow is not merely simultaneous; it has a lead-lag component where MSFT predicts AAPL. This supports a "common factor" theory of liquidity provision.

In summary, valid, high-accuracy prediction of order flow is possible using accessible econometric tools. While not a direct money-printing machine due to execution constraints, it represents a confirmed inefficiency in the temporal structure of market liquidity.

\end{document}
